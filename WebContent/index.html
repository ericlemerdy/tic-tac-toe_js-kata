<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" 
                    "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
<link rel="stylesheet" href="offline/qunit.css" type="text/css"
	media="screen" />
<script type="text/javascript" src="offline/jquery-latest.js"></script>
<script type="text/javascript" src="offline/qunit.js"></script>
<script type="text/javascript" src="offline/backbone/underscore.js"></script>
<script type="text/javascript" src="offline/backbone/backbone.js"></script>

<script>
	Game = Backbone.Model.extend({
		initialize: function() {
			this.set({
				"fields": new Array(".",".",".",".",".",".",".",".","."),
				"currentPlayer": "X",
				"winner": null,
				"isGameOver": false
			});
		},
		take: function(field) {
			if (!this.get("isGameOver") &&
					this.get("fields")[field-1] == ".") {
				var fields_array = this.get("fields");
				fields_array.splice(field - 1, 1, this.get("currentPlayer"));
				this.set({ fields: fields_array });
				this._switchPlayers();
				this.isOver();
			}
			return this;
		},
		_switchPlayers: function() {
			if ("X" == this.get("currentPlayer")) {
				this.set({currentPlayer: "O"});
			} else {
				this.set({currentPlayer: "X"});
			}
		},
		_threeFieldsTakenByTheSamePlayer: function(field1, field2, field3) {
			return this.get("fields")[field1 - 1] != "." &&
				this.get("fields")[field1 - 1] == this.get("fields")[field2 - 1] &&
				this.get("fields")[field2 - 1] == this.get("fields")[field3 - 1];
		},
		isOver: function() {
			var firstLineTaken = this._threeFieldsTakenByTheSamePlayer(1, 2, 3);
			var secondLineTaken = this._threeFieldsTakenByTheSamePlayer(4, 5, 6);
			var thirdLineTaken = this._threeFieldsTakenByTheSamePlayer(7, 8, 9);

			var firstColumnTaken = this._threeFieldsTakenByTheSamePlayer(1, 4, 7);
			var secondColumnTaken = this._threeFieldsTakenByTheSamePlayer(2, 5, 8);
			var thirdColumnTaken = this._threeFieldsTakenByTheSamePlayer(3, 6, 9);

			var diagonalOneTaken = this._threeFieldsTakenByTheSamePlayer(1, 5, 9);
			var diagonalTwoTaken = this._threeFieldsTakenByTheSamePlayer(3, 5, 7);

			if (firstLineTaken || secondLineTaken || thirdLineTaken || firstColumnTaken || secondColumnTaken
					|| thirdColumnTaken || diagonalOneTaken || diagonalTwoTaken) {
				this._switchPlayers();
				this.set({ winner: this.get("currentPlayer") });
				this.set({ message: this.get("winner") + " won" });
				return;
			}
			var allFieldsAreTaken = true;
			$.each(this.get("fields"), function(index, value) {
				allFieldsAreTaken = allFieldsAreTaken && (value != ".");
			});
			if (allFieldsAreTaken) {
				this.set( { isGameOver: true } );
			}
		}
	});
	
    tests = function() {
		module("With reset the grid", {
			setup : function() {
				game = new Game();
			}
		});
		test("A field can be taken", function() {
			expect(1);
			game.take(1);
			equals(game.get("fields")[0], "X", "Field 1 should have been taken by X.");
		});
		test("A non-blank field can't be taken", function() {
			expect(1);
			game.take(1).take(1);
			equals(game.get("fields")[0], "X", "Field 1 should have been taken by X.");
		});
		test("The game instance is not a singleton", function() {
			expect(4);
			game.take(1);
			game = new Game();
			equals(game.get("fields")[0], ".", "Field 1 should have been restored to default.");
			ok(!game.get("isGameOver"), "The game should not be over");
			equals(null, game.get("winner"), "The game should not have a winner.");
			equals(game.get("currentPlayer"), "X", "Current player should have been restored to default.");
		});
		test("The game is over when all fields are taken", function() {
			expect(1);
			game.take(1).take(3).take(2).take(4).take(6).take(5).take(7).take(8).take(9);
			ok(game.get("isGameOver"), "The game should be over when all fields are taken.");
		});
		test("Players are taking fields alternatively", function() {
			expect(2);
			equals(game.get("currentPlayer"), "X", "Initially, the current player is X.");
			game.take(1);
			equals(game.get("currentPlayer"), "O", "The current player should now be O.");
		});
		test("The game is won by O if the first line is taken by O.", function() {
			expect(1);
			game.take(9).take(1).take(5).take(2).take(7).take(3);
			equals(game.get("winner"), "O", "The game should be won by player O.");
		});
		test("The game is won by X if the second line is taken by X.", function() {
			expect(1);
			game.take(4).take(1).take(5).take(2).take(6);
			equals(game.get("winner"), "X", "The game should be won by player X.");
		});
		test("The game is won by O if the third line is taken by O.", function() {
			expect(1);
			game.take(1).take(7).take(5).take(8).take(3).take(9);
			equals(game.get("winner"), "O", "The game should be won by player O.");
		});
		test("The game is won by X if the first column is taken by X.", function() {
			expect(1);
			game.take(1).take(2).take(4).take(5).take(7);
			equals(game.get("winner"), "X", "The game should be won by player X.");
		});
		test("The game is won by O if the second column is taken by O.", function() {
			expect(1);
			game.take(1).take(2).take(4).take(5).take(9).take(8);
			equals(game.get("winner"), "O", "The game should be won by player O.");
		});
		test("The game is won by X if the third column is taken by X.", function() {
			expect(1);
			game.take(3).take(2).take(6).take(5).take(9);
			equals(game.get("winner"), "X", "The game should be won by player X.");
		});
		test("The game is won by X if first diagonal is taken by X.", function() {
			expect(1);
			game.take(1).take(2).take(5).take(3).take(9);
			equals(game.get("winner"), "X", "The game should be won by player X.");
		});
		test("The game is won by O if second diagonal is taken by O.", function() {
			expect(1);
			game.take(1).take(3).take(4).take(5).take(9).take(7);
			equals(game.get("winner"), "O", "The game should be won by player O.");
		});
	}
	
    GameView = Backbone.View.extend({
        initialize: function(){
            this.render();
        },
    	render: function () {
			var template = _.template($("#gameTemplate").html(), {});
			this.el.html(template);
		},
		events: {
			"click .grid>td": "take"
		},
		take: function(event) {
			game.take(event.currentTarget.id);
		}
    });

	$(document).ready(tests);
    $(document).ready(function (){
    	new GameView({ el: $("#game") });
    });
</script>
<style type="text/template" id="gameTemplate">
	<p>
		Current Player: <span id="currentPlayer">X</span>
	</p>
	<p>The grid:</p>
	<div id="grid">
		<table>
			<tr>
				<td id="1">.</td>
				<td id="2">.</td>
				<td id="3">.</td>
			</tr>
			<tr>
				<td id="4">.</td>
				<td id="5">.</td>
				<td id="6">.</td>
			</tr>
			<tr>
				<td id="7">.</td>
				<td id="8">.</td>
				<td id="9">.</td>
			</tr>
		</table>
	</div>
	<p id="message"></p>
	<button id="resetButton" onclick="game.reset()">reset</button>
</style>
<style>
#grid td {
	width: 1em;
	height: 1em;
	text-align: center;
	border: 1px solid black;
}
</style>
</head>
<body>
	<div id="game"></div>
	<h1 id="qunit-header">QUnit example</h1>
	<h2 id="qunit-banner"></h2>
	<div id="qunit-testrunner-toolbar"></div>
	<h2 id="qunit-userAgent"></h2>
	<ol id="qunit-tests"></ol>
	<div id="qunit-fixture">test markup, will be hidden</div>
</body>
</html>